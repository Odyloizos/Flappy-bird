<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Flappy Bird MVP (With Sound)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none; 
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        canvas {
            display: block;
            background-color: #70c5ce; 
            border: 2px solid #000;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .message {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #000;
            padding: 20px;
            border-radius: 10px;
            display: none; 
            pointer-events: auto; 
            box-shadow: 4px 4px 0 #000;
        }

        h1 { margin: 0 0 10px 0; font-size: 24px; color: #333; }
        p { margin: 0 0 15px 0; font-size: 14px; color: #555; }
        
        button {
            background: #e65f28;
            color: white;
            border: 2px solid #000;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 2px 2px 0 #000;
        }
        button:active { transform: translate(2px, 2px); box-shadow: none; }

        #score-display {
            position: absolute;
            top: 10%;
            width: 100%;
            text-align: center;
            font-size: 40px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
            pointer-events: none;
        }

        body.state-start #start-msg { display: block; }
        body.state-gameover #gameover-msg { display: block; }
    </style>
</head>
<body class="state-start">

    <div id="game-container">
        <div id="score-display">0</div>
        <canvas id="gameCanvas" width="320" height="480"></canvas>
        
        <div id="ui-layer">
            <div id="start-msg" class="message">
                <h1>FLAPPY MVP</h1>
                <p>Tap, Click, or Space to Fly</p>
                <button onclick="startGame()">Play</button>
            </div>

            <div id="gameover-msg" class="message">
                <h1>GAME OVER</h1>
                <p>Score: <span id="final-score">0</span></p>
                <button onclick="resetGame()">Try Again</button>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO ENGINE (Web Audio API) ---
        const AudioEngine = {
            ctx: null,
            
            init: function() {
                if (!this.ctx) {
                    // Create Audio Context only after user interaction
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                // Resume if suspended (browser policy)
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            playTone: function(type) {
                if (!this.ctx) return;

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;

                if (type === 'jump') {
                    osc.type = 'sine';
                    // Frequency sweep: rising pitch
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.exponentialRampToValueAtTime(500, now + 0.1);
                    // Envelope: short fade out
                    gain.gain.setValueAtTime(0.5, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } 
                else if (type === 'score') {
                    osc.type = 'square'; // Retro sound
                    osc.frequency.setValueAtTime(1000, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now);
                    osc.stop(now + 0.15);
                }
                else if (type === 'crash') {
                    osc.type = 'sawtooth'; // Rough sound
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                    gain.gain.setValueAtTime(0.5, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            }
        };

        // --- GAME PHYSICS & LOGIC ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let frames = 0;
        let score = 0;
        let gameState = 'START';
        const GRAVITY = 0.25;
        const JUMP = 4.6;
        const SPEED = 2;
        
        const bird = {
            x: 50, y: 150, w: 34, h: 24, radius: 12, velocity: 0, rotation: 0,
            
            draw: function() {
                ctx.save();
                ctx.translate(this.x + this.w/2, this.y + this.h/2);
                // Rotate bird based on velocity
                let rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (this.velocity * 0.1)));
                ctx.rotate(rotation);

                // Body
                ctx.fillStyle = "#FFD700";
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();
                
                // Eye & Pupil
                ctx.fillStyle = "#FFF";
                ctx.beginPath();
                ctx.arc(6, -6, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = "#000";
                ctx.beginPath();
                ctx.arc(8, -6, 2, 0, Math.PI*2);
                ctx.fill();
                
                // Wing
                ctx.fillStyle = "#e6ac00";
                ctx.beginPath();
                ctx.ellipse(-2, 2, 8, 5, 0, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();

                ctx.restore();
            },
            
            update: function() {
                this.velocity += GRAVITY;
                this.y += this.velocity;
                
                if(this.y + this.h >= canvas.height - 20) {
                    this.y = canvas.height - 20 - this.h;
                    gameOver();
                }
                if(this.y < 0) {
                    this.y = 0;
                    this.velocity = 0;
                }
            },
            
            flap: function() {
                this.velocity = -JUMP;
                AudioEngine.playTone('jump');
            }
        };

        const pipes = {
            position: [],
            w: 52, h: 400, gap: 100, dx: SPEED,
            
            draw: function() {
                for(let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    let topY = p.y;
                    let bottomY = p.y + this.h + this.gap;
                    
                    ctx.fillStyle = "#73bf2e";
                    ctx.fillRect(p.x, topY, this.w, this.h);
                    ctx.fillRect(p.x, bottomY, this.w, this.h);
                    
                    ctx.lineWidth = 2;
                    ctx.strokeRect(p.x, topY, this.w, this.h);
                    ctx.strokeRect(p.x, bottomY, this.w, this.h);
                    
                    // Pipe Cap Details
                    ctx.fillStyle = "#63a528"; // Shadow
                    ctx.fillRect(p.x + 40, topY, 6, this.h);
                    ctx.fillRect(p.x + 40, bottomY, 6, this.h);
                }
            },
            
            update: function() {
                if(frames % 120 === 0) {
                    this.position.push({
                        x: canvas.width,
                        y: -150 * (Math.random() + 1),
                        passed: false
                    });
                }
                
                for(let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    p.x -= this.dx;
                    
                    // Collision
                    if(bird.x + bird.w > p.x && bird.x < p.x + this.w) {
                        if(bird.y < p.y + this.h || bird.y + bird.h > p.y + this.h + this.gap) {
                            gameOver();
                        }
                    }
                    
                    // Score
                    if(p.x + this.w < bird.x && !p.passed) {
                        score++;
                        document.getElementById('score-display').innerText = score;
                        p.passed = true;
                        AudioEngine.playTone('score');
                    }
                    
                    if(p.x + this.w <= 0) {
                        this.position.shift();
                        i--;
                    }
                }
            },
            reset: function() { this.position = []; }
        };

        const background = {
            draw: function() {
                ctx.fillStyle = "#ded895";
                ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
                ctx.strokeRect(0, canvas.height - 20, canvas.width, 20);
                ctx.fillStyle = "#73bf2e";
                ctx.fillRect(0, canvas.height - 20, canvas.width, 4);
            }
        };

        // --- MAIN LOOPS ---
        function loop() {
            if (gameState === 'PLAYING') {
                bird.update();
                pipes.update();
                draw();
                frames++;
                requestAnimationFrame(loop);
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pipes.draw();
            background.draw();
            bird.draw();
        }

        // --- CONTROLS ---
        function startGame() {
            AudioEngine.init(); // Must happen on user click
            if(gameState === 'PLAYING') return;
            document.body.className = '';
            score = 0;
            frames = 0;
            document.getElementById('score-display').innerText = score;
            bird.y = 150;
            bird.velocity = 0;
            pipes.reset();
            gameState = 'PLAYING';
            bird.flap(); // Initial jump
            loop();
        }

        function gameOver() {
            if(gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            AudioEngine.playTone('crash');
            document.body.className = 'state-gameover';
            document.getElementById('final-score').innerText = score;
        }

        function resetGame() { startGame(); }

        function inputAction(e) {
            if (e.type === 'keydown' && e.code !== 'Space') return;
            if (e.type === 'touchstart') e.preventDefault();

            if (gameState === 'PLAYING') {
                bird.flap();
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') inputAction(e);
        });
        canvas.addEventListener('mousedown', inputAction);
        canvas.addEventListener('touchstart', inputAction, {passive: false});

        draw(); // Initial render
    </script>
</body>
</html>
